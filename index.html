<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Scroll-Triggered Audio (BoundingClientRect)</title>
  <style>
    html, body { margin:0; padding:0; }
    #startStop {
      position: fixed; top:10px; left:10px; z-index:100;
      padding:8px 12px; font-size:16px;
    }
    section {
      height:100vh;
      display:flex; justify-content:center; align-items:center;
      font-size:2rem;
    }
    section[data-track="rain"]  { background:#e0f7fa; }
    section[data-track="piano"] { background:#ffe0b2; }
    section[data-track="kids"]  { background:#c8e6c9; }
  </style>
</head>
<body>
  <button id="startStop">Start Audio</button>

  <audio id="rain"  src="rain.mp3"          preload="auto" loop></audio>
  <audio id="piano" src="piano.mp3"         preload="auto" loop></audio>
  <audio id="kids"  src="kids_playing.mp3"  preload="auto" loop></audio>

  <section data-track="rain">Rain Sound</section>
  <section data-track="piano">Piano Sound</section>
  <section data-track="kids">Kids Playing</section>

  <script>
    const btn     = document.getElementById('startStop');
    const audios  = {};   // { el:HTMLAudioElement, started:boolean }
    const secs    = {};   // 各セクション要素

    // 要素をキャッシュ
    ['rain','piano','kids'].forEach(id => {
      audios[id] = { el: document.getElementById(id), started: false };
      secs[id]   = document.querySelector(`section[data-track="${id}"]`);
    });

    function isFullyVisible(el) {
      const r = el.getBoundingClientRect();
      return r.top >= 0 && r.bottom <= window.innerHeight;
    }

    function onScroll() {
      Object.keys(secs).forEach(id => {
        const a = audios[id];
        if (!a.started && isFullyVisible(secs[id])) {
          a.el.muted   = false;
          a.started    = true;
        }
      });
    }

    btn.addEventListener('click', () => {
      if (btn.dataset.running) {
        // ■ Stop & reset
        window.removeEventListener('scroll', onScroll);
        Object.values(audios).forEach(a => {
          a.el.pause();
          a.el.currentTime = 0;
          a.el.muted       = true;
          a.started        = false;
        });
        btn.textContent = 'Start Audio';
        delete btn.dataset.running;
      } else {
        // ■ Start
        btn.dataset.running = 'true';
        btn.textContent     = 'Stop Audio';

        // 再生をタップ内で一度だけアンロック＋完全ミュート
        Object.values(audios).forEach(a => {
          a.el.muted = true;
          a.el.play().catch(()=>{});
        });

        // スクロールでそれぞれのセクションを判定
        window.addEventListener('scroll', onScroll, { passive: true });
        // 初期スクロール判定（ページ読込直後にセクション１が見えている場合）
        onScroll();
      }
    });
  </script>
</body>
</html>
