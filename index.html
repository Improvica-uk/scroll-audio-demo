<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Scroll-Triggered Audio (BoundingClientRect + GainNode)</title>
  <style>
    html, body { margin:0; padding:0; }
    #startStop {
      position: fixed; top:10px; left:10px; z-index:100;
      padding:8px 12px; font-size:16px;
    }
    section {
      height:100vh;
      display:flex; justify-content:center; align-items:center;
      font-size:2rem;
    }
    section[data-track="rain"]  { background:#e0f7fa; }
    section[data-track="piano"] { background:#ffe0b2; }
    section[data-track="kids"]  { background:#c8e6c9; }
  </style>
</head>
<body>
  <button id="startStop">Start Audio</button>

  <!-- Place these MP3s next to this file on your server -->
  <audio id="rain"  src="rain.mp3"          preload="auto" loop></audio>
  <audio id="piano" src="piano.mp3"         preload="auto" loop></audio>
  <audio id="kids"  src="kids_playing.mp3"  preload="auto" loop></audio>

  <section data-track="rain">Rain Sound</section>
  <section data-track="piano">Piano Sound</section>
  <section data-track="kids">Kids Playing</section>

  <script>
    (function(){
      const btn     = document.getElementById('startStop');
      let   audioCtx, tracks, sections, running = false;

      function isFullyInView(el) {
        const r = el.getBoundingClientRect();
        return r.top >= 0 && r.bottom <= window.innerHeight;
      }

      function onScroll() {
        sections.forEach(sec => {
          const id = sec.dataset.track;
          const t  = tracks[id];
          if (!t.started && isFullyInView(sec)) {
            // fade in volume via GainNode
            t.gain.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.1);
            t.started = true;
          }
        });
      }

      btn.addEventListener('click', async () => {
        if (!running) {
          // ■ Start
          running = true;
          btn.textContent = 'Stop Audio';

          // 1) Create AudioContext
          audioCtx = new (window.AudioContext||window.webkitAudioContext)();

          // 2) Prepare tracks + GainNodes
          tracks   = {};
          sections = Array.from(document.querySelectorAll('section[data-track]'));

          sections.forEach(sec => {
            const id    = sec.dataset.track;
            const audio = document.getElementById(id);
            const src   = audioCtx.createMediaElementSource(audio);
            const gain  = audioCtx.createGain();
            gain.gain.value = 0;                    // start silent
            src.connect(gain).connect(audioCtx.destination);
            tracks[id] = { gain, started: false };
            audio.play().catch(()=>{});             // unlock playback on iOS
          });

          // 3) Listen scroll (passive for performance)
          window.addEventListener('scroll', onScroll, { passive: true });
          // initial check in case section1 is already fully visible
          onScroll();
        }
        else {
          // ■ Stop & reset
          running = false;
          btn.textContent = 'Start Audio';
          window.removeEventListener('scroll', onScroll);

          // reset each audio element
          sections.forEach(sec => {
            const id    = sec.dataset-track;
            const audio = document.getElementById(id);
            audio.pause();
            audio.currentTime = 0;
            tracks[id].gain.gain.cancelScheduledValues(audioCtx.currentTime);
            tracks[id].gain.gain.value = 0;
            tracks[id].started = false;
          });

          await audioCtx.close();
          audioCtx = null;
        }
      });
    })();
  </script>
</body>
</html>
