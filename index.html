<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Scroll-Triggered Audio with Howler.js</title>
  <style>
    html,body {margin:0;padding:0;}
    #startStop {position:fixed;top:10px;left:10px;z-index:100;padding:8px 12px;}
    section {height:100vh;display:flex;align-items:center;justify-content:center;font-size:2rem;}
    section[data-track="rain"]  {background:#e0f7fa;}
    section[data-track="piano"] {background:#ffe0b2;}
    section[data-track="kids"]  {background:#c8e6c9;}
  </style>
</head>
<body>
  <button id="startStop">Start Audio</button>

  <!-- Howler.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

  <audio id="rain"  src="rain.mp3"></audio>
  <audio id="piano" src="piano.mp3"></audio>
  <audio id="kids"  src="kids_playing.mp3"></audio>

  <section data-track="rain">Rain Sound</section>
  <section data-track="piano">Piano Sound</section>
  <section data-track="kids">Kids Playing</section>

  <script>
    // 1) Howler で各トラックを定義（preload＋ループ＋初期ボリューム0）
    const tracks = {
      rain:  new Howl({ src:['rain.mp3'],  preload:true, loop:true, volume:0 }),
      piano: new Howl({ src:['piano.mp3'], preload:true, loop:true, volume:0 }),
      kids:  new Howl({ src:['kids_playing.mp3'], preload:true, loop:true, volume:0 })
    };

    const btn = document.getElementById('startStop');
    const secs = document.querySelectorAll('section[data-track]');

    // 要素が完全にビューポート内にあるかチェック
    function isFullyVisible(el) {
      const r = el.getBoundingClientRect();
      return r.top >= 0 && r.bottom <= window.innerHeight;
    }

    // スクロールで音量をアンミュート
    function onScroll() {
      secs.forEach(sec => {
        const id = sec.dataset.track;
        if (!tracks[id]._volume && isFullyVisible(sec)) {
          tracks[id].volume(0.5);  // ミュート解除
        }
      });
    }

    btn.addEventListener('click', () => {
      if (btn.dataset.running) {
        // ■ Stop
        window.removeEventListener('scroll', onScroll);
        Object.values(tracks).forEach(h => { h.stop(); h.volume(0); });
        btn.textContent = 'Start Audio';
        delete btn.dataset.running;
      } else {
        // ■ Start（ここがポイント：click 内で一発で play()）
        btn.dataset.running = 'true';
        btn.textContent = 'Stop Audio';
        Object.values(tracks).forEach(h => h.play());         // 再生アンロック
        window.addEventListener('scroll', onScroll, { passive:true });
        onScroll(); // ページロード時に section1 など既に見えているなら即時アンミュート
      }
    });
  </script>
</body>
</html>
