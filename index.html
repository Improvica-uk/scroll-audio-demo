<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Canvas Background + Tap Audio Demo</title>
  <style>
    html, body { margin:0; padding:0; overflow-x:hidden; }
    /* スクロール領域を作るために body 高さを指定 */
    body { height:300vh; }
    /* Canvas を固定配置 */
    canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
    }
    /* 説明テキスト */
    #hint {
      position: fixed;
      top: 10px; left: 10px;
      background: rgba(0,0,0,0.5);
      color: white; padding: 8px;
      font-size: 1rem; border-radius: 4px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="hint">▶︎ Canvas をタップすると、「雨」「ピアノ」「子供」が順に再生</div>
  <canvas id="bg"></canvas>

  <!-- Howler.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <script>
  (function() {
    const canvas = document.getElementById('bg');
    const ctx    = canvas.getContext('2d');

    // Canvas を viewport, 3×viewport 高さに合わせる
    function resize() {
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    // 背景に使う３つの video 要素を準備
    const videoSrcs = ['rain.mp4','piano.mp4','kids.mp4'];
    const videos = videoSrcs.map(src => {
      const v = document.createElement('video');
      v.src       = src;
      v.loop      = true;
      v.muted     = true;
      v.playsInline = true;
      v.autoplay  = true;
      v.play().catch(()=>{});  // 自動再生トライ
      return v;
    });

    // ループ描画
    function draw() {
      const H = window.innerHeight, W = window.innerWidth;
      ctx.clearRect(0,0,W,H*3);
      videos.forEach((v,i) => {
        ctx.drawImage(v, 0, H*i, W, H);
      });
      requestAnimationFrame(draw);
    }
    draw();

    // Howler.js で音声トラックを用意
    const tracks = {
      rain:  new Howl({ src:['rain.mp3'],         loop:true, volume:0.7, html5:true }),
      piano: new Howl({ src:['piano.mp3'],        loop:true, volume:0.7, html5:true }),
      kids:  new Howl({ src:['kids_playing.mp3'], loop:true, volume:0.7, html5:true })
    };

    // タップ位置でセクション判定＆トグル再生
    canvas.addEventListener('pointerdown', e => {
      // 事前に iOS での再生アンロックを兼ねる
      Object.values(tracks).forEach(h => { if (!h.playing()) h.play(); });

      const y = e.clientY + window.scrollY;
      const idx = Math.floor(y / window.innerHeight);
      const ids = ['rain','piano','kids'];
      const id = ids[idx];
      if (!id || !tracks[id]) return;

      const h = tracks[id];
      if (h.playing(id)) {
        h.stop();
      } else {
        h.play();
      }
    });
  })();
  </script>
</body>
</html>
